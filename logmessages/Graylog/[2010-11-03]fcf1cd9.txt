  more bug fixing and refactoring  