  proper fix for handling identical keys (cherry-picked from f09ac2d)  