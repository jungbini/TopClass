  introduce variable: fix broken formatting, add test, set explicit caret position after refactoring, cleanup  