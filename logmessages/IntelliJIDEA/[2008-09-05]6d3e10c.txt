  Reformatted sources and fixed some problems with closing streams  