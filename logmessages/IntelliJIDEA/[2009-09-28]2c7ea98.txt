  TreeUi: massive refactorings and bug fixes  