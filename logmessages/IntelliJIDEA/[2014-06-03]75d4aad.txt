  several fixes from trunk cherry-picked  