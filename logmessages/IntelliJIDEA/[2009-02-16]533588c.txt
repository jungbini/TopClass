  LH: deadlock fix IDEA-21906 + some refactoring  