  add graph pieces tests and fix several bugs  