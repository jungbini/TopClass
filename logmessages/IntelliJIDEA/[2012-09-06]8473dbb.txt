  fixed unused code (produced NPE) and tests  