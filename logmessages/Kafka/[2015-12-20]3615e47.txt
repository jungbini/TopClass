  KAFKA-2058: Fix ProducerTest.testSendWithDeadBroker transient failure  It turns that waitUntilMetadataIsPropagated is not enough; in "onBrokerStartup", methods below will send send both LeaderAndIsrRequest and UpdateMetadataRequest to KafkaApis: replicaStateMachine.handleStateChanges(allReplicasOnNewBrokers, OnlineReplica) partitionStateMachine.triggerOnlinePartitionStateChange() The two kinds of request are handled seperately and we are not sure about the order; If UpdateMetadataRequest is handled first, metadataCache of kafkaApis will be updated, thus TestUtils.waitUntilMetadataIsPropagated will be satisfied, and consumer can(will) start fetching data; But if the LeaderAndIsrRequest is not handled at this moment, "becomeLeaderOrFollower" cannot be called , thus structures like "leaderReplicaOpt" cannot be updated, which leads to failure of consumer's fetching data; To fix above, consumer should start fetching data after partition's leaderReplica is refreshed, not just the leader is elected; So added "TestUtils.waitUntilLeaderIsKnown(servers, topic, 0)"  Author: ZoneMayor <jinxing6042@126.com> Author: jinxing <jinxing@fenbi.com>  Reviewers: Ismael Juma, Guozhang Wang  Closes #689 from ZoneMayor/trunk-KAFKA-2058  