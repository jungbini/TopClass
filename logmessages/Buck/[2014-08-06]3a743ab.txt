 fixes race conditions and adds tests to ensure they don't regress.  Test Plan: buck test --all  