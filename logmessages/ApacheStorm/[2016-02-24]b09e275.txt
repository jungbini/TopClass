 update/fix some codes based on @revans2  