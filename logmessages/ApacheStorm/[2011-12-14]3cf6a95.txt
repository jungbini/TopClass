  fixed bugs in transition function  