  Implementing new logic of choosing the daemon, startup and shutdown, some related refactorings and fixes  