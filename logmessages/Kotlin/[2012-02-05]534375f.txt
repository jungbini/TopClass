  a bunch or refactoring and TODO fixes  