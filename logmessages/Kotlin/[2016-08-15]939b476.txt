  Added tests, and fixed some bugs using it  