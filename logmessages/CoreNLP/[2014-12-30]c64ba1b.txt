  Fix bug, separate out some methods, add tests.  