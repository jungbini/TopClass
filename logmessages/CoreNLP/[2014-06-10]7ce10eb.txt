  Re-factored and fixed re-entrancy issues  