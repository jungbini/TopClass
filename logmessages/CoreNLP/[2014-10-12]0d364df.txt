  Fix bug in definition of equals (and other minor clean up).  