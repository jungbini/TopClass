  fix #578 #577 and #574  