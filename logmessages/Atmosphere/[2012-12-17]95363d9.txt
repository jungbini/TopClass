  Final fix for #779, improve #765  