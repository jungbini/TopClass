  Port synchronization fix from branch, preventing two threads calling onStateChange  