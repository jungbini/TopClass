  fixed logic issues with error handling  