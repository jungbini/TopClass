 Refactor prepareUFSFilePath and fix test cases  