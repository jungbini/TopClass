  code cleanups and fixing part of #2799  