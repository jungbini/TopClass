  fixes to make the size() method work properly, other preproc bits  