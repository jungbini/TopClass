 merge fixes for #1400 with updates to #3088  