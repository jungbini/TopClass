  major refactor and bug fixing in the namespace handling code  