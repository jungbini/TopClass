  FFI port of 3ff0a33d and 2157b653 (fix for #303)  