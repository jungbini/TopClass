  Some refactorings and a NPE fix.  